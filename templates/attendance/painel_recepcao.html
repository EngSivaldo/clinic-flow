{% extends "layouts/base-tv.html" %}
{% load static %}

{% block title %}TV 01 ‚Ä¢ RECEP√á√ÉO E TRIAGEM{% endblock %}

{% block content %}
<div id="interaction-overlay" onclick="startPanel()" class="fixed inset-0 z-[999] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center cursor-pointer">
    <div class="text-center text-white">
        <div class="text-6xl mb-4">üîä</div>
        <p class="text-2xl font-black uppercase tracking-widest">Clique em qualquer lugar <br> para ativar o som do painel</p>
    </div>
</div>

<div class="h-full flex flex-col p-6 gap-6 overflow-hidden bg-slate-900">
    <header class="bg-[#004a99] p-6 rounded-3xl shadow-2xl flex items-center justify-between border-b-[8px] border-blue-900">
        <div class="flex items-center gap-6">
            <div class="bg-white p-2 rounded-xl shadow-inner">
                <img src="https://ui-avatars.com/api/?name=SUS&background=fff&color=004a99&size=128" alt="Logo" class="w-14 h-14">
            </div>
            <div>
                <h1 class="text-3xl font-black text-white tracking-tighter uppercase leading-none">Prefeitura de Tucuru√≠</h1>
                <p class="text-blue-300 font-bold uppercase tracking-[0.3em] text-sm mt-1">Recep√ß√£o e Triagem</p>
            </div>
        </div>
        <div class="text-right text-white">
            <div class="text-5xl font-black tabular-nums leading-none" id="clock">00:00</div>
            <div class="text-blue-200 font-bold text-lg uppercase tracking-widest" id="date">-- --- ----</div>
        </div>
    </header>

    <main class="flex-grow grid grid-cols-12 gap-6 mb-24"> 
        <input type="hidden" id="current-ticket-id" value="{{ atual.codigo }}">
        <input type="hidden" id="current-status" value="{{ atual.status }}">
        <input type="hidden" id="current-name" value="{{ atual.paciente.nome }}">

        <div class="col-span-8 bg-white rounded-[3.5rem] shadow-2xl border border-slate-200 p-6 flex flex-col justify-between text-center relative overflow-hidden h-full">
            <div class="absolute top-0 left-0 w-full h-3 bg-yellow-400"></div>
            
            <h2 class="text-slate-400 font-black text-2xl uppercase tracking-[0.2em] mt-2">
                {% if atual.status == 'EM_TRIAGEM' %}EM ATENDIMENTO{% else %}COMPARECER √Ä TRIAGEM{% endif %}
            </h2>

            <div class="mt-4 py-6 px-6 rounded-full transition-all duration-500 {% if atual.status == 'EM_TRIAGEM' %}bg-blue-600 animate-pulse{% else %}bg-emerald-500{% endif %}">
                <span class="text-white text-5xl font-black uppercase italic tracking-widest">
                    {% if atual.status == 'EM_TRIAGEM' %}
                        EM ATENDIMENTO
                    {% else %}
                        SENHA: {{ atual.codigo|default:"---" }}
                    {% endif %}
                </span>
            </div>

            <div class="pb-4">
                <p class="text-7xl font-black text-slate-800 uppercase tracking-tight mb-4 break-words leading-tight px-4">
                    {{ atual.paciente.nome|default:"Aguarde sua vez..." }}
                </p>
                <div class="inline-flex items-center gap-4 bg-emerald-100 text-emerald-700 px-10 py-3 rounded-2xl border border-emerald-200">
                    <span class="text-2xl font-black uppercase tracking-widest">SALA DE TRIAGEM</span>
                </div>
            </div>
        </div>

        <div class="col-span-4 flex flex-col gap-6 h-full">
            <div class="bg-slate-800 rounded-[2.5rem] p-6 shadow-2xl flex-grow border border-slate-700 overflow-hidden">
                <h3 class="text-slate-400 font-black text-lg uppercase tracking-widest mb-4 border-b border-slate-700 pb-3 text-center">Pr√≥ximas Senhas</h3>
                <div class="flex flex-wrap gap-4 justify-center">
                    {% for p in proximos %}
                    <div class="bg-slate-700 text-white px-6 py-4 rounded-xl border-b-4 border-slate-900 shadow-md flex flex-col items-center min-w-[120px]">
                        <span class="text-4xl font-black">{{ p.codigo }}</span>
                        <span class="text-[10px] text-slate-400 font-bold uppercase truncate w-full text-center">{{ p.paciente.nome }}</span>
                    </div>
                    {% empty %}
                    <div class="flex flex-col items-center opacity-20 mt-10">
                        <p class="text-slate-500 font-bold italic uppercase text-sm text-center">Fila vazia</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] p-6 shadow-xl border border-slate-200 text-center">
                <p class="text-slate-500 font-bold leading-tight text-lg">
                    Tenha em m√£os seu <br> <span class="text-blue-600 font-black text-xl">DOCUMENTO COM FOTO</span>.
                </p>
            </div>
        </div>
    </main>
</div>

<audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto" loop></audio>
{% endblock %}


{% block extra_js %}
<script>
    let isAnnouncing = false;

    // Rel√≥gio
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        document.getElementById('date').textContent = now.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short', year: 'numeric'});
    }
    setInterval(updateClock, 1000);

    // In√≠cio manual para liberar o navegador
    function startPanel() {
        document.getElementById('interaction-overlay').classList.add('hidden');
        const audio = document.getElementById('alert-sound');
        audio.play().then(() => { audio.pause(); }).catch(e => console.log("Aguardando clique..."));
        fetchData();
    }

    function fetchData() {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Atualiza a tela (Verde/Azul)
                document.querySelector('main').innerHTML = doc.querySelector('main').innerHTML;
                
                const newStatus = doc.querySelector('#current-status')?.value;
                const newName = doc.querySelector('#current-name')?.value;
                const newTicket = doc.querySelector('#current-ticket-id')?.value;
                const audio = document.getElementById('alert-sound');

                // L√ìGICA QUE FUNCIONOU: SE EST√Å VERDE, TOCA
                if (newStatus === 'CHAMADO_TRIAGEM') {
                    // Sino em loop
                    audio.loop = true;
                    audio.play().catch(e => console.log("Navegador bloqueou √°udio. Clique na TV."));

                    // Voz (se n√£o estiver falando)
                    if (!isAnnouncing) {
                        playVoiceLoop(newName, newTicket);
                    }
                } 
                // SE MUDOU PARA AZUL OU SUMIU, PARA TUDO
                else {
                    audio.pause();
                    audio.currentTime = 0;
                    window.speechSynthesis.cancel();
                    isAnnouncing = false;
                }
            });
    }

    function playVoiceLoop(name, ticket) {
        if (isAnnouncing) return;
        isAnnouncing = true;

        function speak() {
            // Verifica se ainda deve continuar (lendo do HTML atualizado)
            const statusAtual = document.getElementById('current-status')?.value;
            if (statusAtual !== 'CHAMADO_TRIAGEM') {
                isAnnouncing = false;
                return;
            }

            // Limpa filas anteriores para n√£o travar
            window.speechSynthesis.cancel(); 

            const msg = new SpeechSynthesisUtterance(`Aten√ß√£o. Paciente ${name}. Senha ${ticket}.`);
            msg.lang = 'pt-BR';
            msg.rate = 0.9;

            msg.onend = function() {
                // Espera 4 segundos e repete
                setTimeout(speak, 4000);
            };

            window.speechSynthesis.speak(msg);
        }
        speak();
    }

    setInterval(fetchData, 3000);
</script>
{% endblock %}

